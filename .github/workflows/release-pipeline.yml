name: OpenCue Release Pipeline

# Trigger this pipeline when a commit is tagged with a version number, e.g. "v0.4.32".
on:
  push:
    tags:
      - "v*"

jobs:
  release_docker_images:
    runs-on: self-hosted
    strategy:
      matrix:
        component: [cuebot, rqd, pycue, pyoutline, cuegui, cuesubmit, cueadmin]

    name: Release ${{ matrix.component }} Docker image
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set build ID
        run: |
          set -e
          echo "${GITHUB_REF/refs\/tags\//}" >> VERSION
          echo "Build ID: $(cat ./VERSION)"
          echo "BUILD_ID=$(cat ./VERSION)" >> ${GITHUB_ENV}

      - name: Pull Docker image from staging
        run: |
          set -e
          docker pull opencuebuild/${{ matrix.component }}:${BUILD_ID}
