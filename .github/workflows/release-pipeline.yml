name: OpenCue Release Pipeline

# Trigger this pipeline when a commit is tagged with a version number, e.g. "v0.4.32".
on:
  push:
    tags:
      - "v*"

jobs:
  preflight:
    runs-on: self-hosted
    name: Preflight
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set build ID
        run: |
          set -e
          hatch version > VERSION
          echo "Build ID: $(cat ./VERSION)"
          echo "BUILD_ID=$(cat ./VERSION)" >> ${GITHUB_ENV}

      - name: Get current tag name
        run: echo "TAG_NAME=${GITHUB_REF/refs\/tags\//}" >> ${GITHUB_ENV}

      - name: Verify tag name and version match
        run: |
          set -e
          if [ "v$(cat VERSION)" != "${TAG_NAME}" ]; then
            echo "Version check failed: code version v$(cat VERSION) does not match tag name ${TAG_NAME}"
            echo "Original GITHUB_REF: ${GITHUB_REF}"
            exit 1
          fi

  release_docker_images:
    needs: preflight
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        component: [cuebot, rqd, pycue, pyoutline, cuegui, cuesubmit, cueadmin]

    name: Release ${{ matrix.component }} Docker image
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set build ID
        run: |
          set -e
          ci/generate_version_number.sh > VERSION
          echo "Build ID: $(cat ./VERSION)"
          echo "BUILD_ID=$(cat ./VERSION)" >> ${GITHUB_ENV}

      - name: Pull Docker image from staging
        run: |
          set -e
          docker pull opencuebuild/${{ matrix.component }}:${BUILD_ID}

