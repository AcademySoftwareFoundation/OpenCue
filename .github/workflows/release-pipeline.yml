name: OpenCue Release Pipeline

# TODO This should only run on pushing a new version tag
on:
  #push:
  #  tags:
  #    - 'v*'
  pull_request:
    branches: [ master ]

jobs:
  build:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Fetch artifacts
        run: |
          set -e
          echo "SHA: ${{github.sha}}"
          run_id=$(curl -s https://api.github.com/repos/${{github.repository}}/actions/runs \
            | jq ".workflow_runs[] | select(.head_sha == \"${{github.sha}}\" and .workflow_id==1539149).id")
          echo "Run ID: ${run_id}"
          artifact_ids=$(curl -s https://api.github.com/repos/${{github.repository}}/actions/runs/${run_id}/artifacts \
            | jq '.artifacts[].id')
          echo "Artifact IDs: ${artifact_ids}"
          for artifact_id in ${artifact_ids}; do
            echo "Fetching artifact ${artifact_id}"
            curl -L -O "https://${{secrets.GITHUB_TOKEN}}@api.github.com/repos/${{github.repository}}/actions/artifacts/$artifact_id/zip"
          done
      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            Changelog WIP
          draft: true
          prerelease: false

