# azure-pipelines template file
# https://docs.microsoft.com/en-us/azure/devops/pipelines/process/templates?view=azure-devops

parameters:
  imageName: ''
  displayName: ''
  artifactPath: ''

steps:
- bash: |
    branch_name=${SYSTEM_PULLREQUEST_SOURCEBRANCH:-$BUILD_SOURCEBRANCHNAME}
    image_id="opencuebuild/${{ parameters.imageName }}:$(setBuildId.buildId)"
    image_id_build="opencuebuild/${{ parameters.imageName }}-build:$(setBuildId.buildId)"
    branch_image_id="opencuebuild/${{ parameters.imageName }}:${branch_name}"
    branch_image_id_build="opencuebuild/${{ parameters.imageName }}-build:${branch_name}"
    
    docker pull $branch_image_id || true
    docker pull $branch_image_id_build || true

    docker build --cache-from $branch_image_id_build --target build -t $image_id_build -f ${{ parameters.imageName }}/Dockerfile .
    docker build --cache-from $branch_image_id -t $image_id -f ${{ parameters.imageName }}/Dockerfile .
    
    docker tag $image_id $branch_image_id
    docker push $image_id_build
    docker push $branch_image_id_build
    docker push $image_id
    docker push $branch_image_id
    
    container_id=$(docker create ${image_id})
    docker cp $container_id:${{ parameters.artifactPath }} "$(ARTIFACT_DIRECTORY)/"
    docker rm $container_id
    echo "dummy change"
  name: ${{ parameters.imageName }}
  displayName: Build and Test ${{ parameters.displayName }}
