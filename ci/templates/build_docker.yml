# azure-pipelines template file
# https://docs.microsoft.com/en-us/azure/devops/pipelines/process/templates?view=azure-devops

parameters:
  imageName: ''
  displayName: ''
  artifactPath: ''

steps:
- bash: |
    set -e

    branch_name=${SYSTEM_PULLREQUEST_SOURCEBRANCH:-$BUILD_SOURCEBRANCHNAME}

    build_image_for_build_id="opencuebuild/${{ parameters.imageName }}-build:$(setBuildId.buildId)"
    build_image_for_branch="opencuebuild/${{ parameters.imageName }}-build:${branch_name}"

    runtime_image_for_build_id="opencuebuild/${{ parameters.imageName }}:$(setBuildId.buildId)"
    runtime_image_for_branch="opencuebuild/${{ parameters.imageName }}:${branch_name}"

    docker pull ${build_image_for_branch} || true

    docker build \
      --target build \
      --cache-from ${build_image_for_branch} \
      -t ${build_image_for_build_id} \
      -t ${build_image_for_branch} \
      -f ${{ parameters.imageName }}/Dockerfile \
      "."

    docker push ${build_image_for_build_id}
    docker push ${build_image_for_branch}

    docker pull ${runtime_image_for_branch} || true

    docker build \
      --cache-from ${build_image_for_build_id} \
      --cache-from ${runtime_image_for_branch} \
      -t ${runtime_image_for_build_id} \
      -t ${runtime_image_for_branch} \
      -f ${{ parameters.imageName }}/Dockerfile \
      "."

    docker push ${runtime_image_for_build_id}
    docker push ${runtime_image_for_branch}
    
    container_id=$(docker create ${runtime_image_for_build_id})
    docker cp $container_id:${{ parameters.artifactPath }} "$(ARTIFACT_DIRECTORY)/"
    docker rm $container_id

  name: ${{ parameters.imageName }}
  displayName: Build and Test ${{ parameters.displayName }}
  dependsOn: createArtifactDirectory
